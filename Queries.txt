/* Query 1 */What is the Most popular genre for each country?*/

SELECT Country, Genre, Purchases
FROM (
    SELECT c.Country,
           g.Name AS Genre,
           COUNT(*) AS Purchases,
           ROW_NUMBER() OVER (PARTITION BY c.Country ORDER BY COUNT(*) DESC) AS rn
    FROM Customer c
    JOIN Invoice i ON c.CustomerId = i.CustomerId
    JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId
    JOIN Track t ON il.TrackId = t.TrackId
    JOIN Genre g ON t.GenreId = g.GenreId
    GROUP BY c.Country, g.Name
) ranked
WHERE rn = 1;



/* Query 2 */What is the top 5 customers spent the most on music for each country?*/

SELECT CustomerId, FirstName, LastName, Country, Total
FROM (
    SELECT c.CustomerId,
           c.FirstName,
           c.LastName,
           c.Country,
           SUM(i.Total) AS Total,
           RANK() OVER (PARTITION BY c.Country ORDER BY SUM(i.Total) DESC) AS rk
    FROM Customer c
    JOIN Invoice i ON c.CustomerId = i.CustomerId
    GROUP BY c.CustomerId, c.FirstName, c.LastName, c.Country
) ranked
WHERE rk <= 5;


/* Query 3 */What is the top 5 customers spent the most on artist earned the most?*/

WITH TopArtist AS (
    SELECT a.ArtistId
    FROM Artist a
    JOIN Album al ON a.ArtistId = al.ArtistId
    JOIN Track t ON al.AlbumId = t.AlbumId
    JOIN InvoiceLine il ON t.TrackId = il.TrackId
    GROUP BY a.ArtistId
    ORDER BY SUM(il.UnitPrice * il.Quantity) DESC
    LIMIT 1
)
SELECT a.Name AS Artist,
       c.CustomerId,
       c.FirstName,
       c.LastName,
       SUM(il.UnitPrice * il.Quantity) AS AmountSpent
FROM Customer c
JOIN Invoice i ON c.CustomerId = i.CustomerId
JOIN InvoiceLine il ON i.InvoiceId = il.InvoiceId
JOIN Track t ON il.TrackId = t.TrackId
JOIN Album al ON t.AlbumId = al.AlbumId
JOIN Artist a ON al.ArtistId = a.ArtistId
WHERE a.ArtistId = (SELECT ArtistId FROM TopArtist)
GROUP BY a.Name, c.CustomerId, c.FirstName, c.LastName
ORDER BY AmountSpent DESC
LIMIT 5;


/* Query 4 */Top 10 HighestEarnings Albums By Genre*/

SELECT Genre, Artist, Album, Earnings
FROM (
    SELECT g.Name AS Genre,
           a.Name AS Artist,
           al.Title AS Album,
           SUM(il.UnitPrice * il.Quantity) AS Earnings,
           RANK() OVER (PARTITION BY g.Name ORDER BY SUM(il.UnitPrice * il.Quantity) DESC) AS rk
    FROM Genre g
    JOIN Track t ON g.GenreId = t.GenreId
    JOIN Album al ON t.AlbumId = al.AlbumId
    JOIN Artist a ON al.ArtistId = a.ArtistId
    JOIN InvoiceLine il ON t.TrackId = il.TrackId
    GROUP BY g.Name, a.Name, al.Title
) ranked
WHERE rk <= 10
ORDER BY Genre, Earnings DESC;

